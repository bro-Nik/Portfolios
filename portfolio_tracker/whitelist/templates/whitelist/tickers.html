{% set only_content = request.args.get('only_content') %}
{% set modal = request.args.get('modal') %}
{% set status = request.args.get('status') %}

{% if not only_content %}
  {% if modal %}
    {% extends "modal_base.html" %}
    {% set modal_fullscreen = True %}
  {% else %}
    {% extends "base.html" %}
    {% block title %} Whitelist {% endblock %}
  {% endif %}
{% endif %}


{% block content %}
<div class="mb-5">
  <div class="row xs-mb-3">
    <div class="col-auto">
      <h1>
        {% if status == 'worked' %}
          Сработавшие уведомления
        {% else %}
          Whitelist
        {% endif %}
      </h1>
    </div>
    {% if not modal %}
      <div class="col-auto ms-auto">
        <button class="btn btn-primary open-modal" type="button" data-modal-id="AddAssetModal" data-url="{{ url_for('portfolio.asset_add_new', market_id=market_id) }}">Добавить актив</button>
      </div>
    {% endif %}
  </div>
</div>
<nav class="nav nav-underline market-menu">
  <span class="nav-link {{ 'active disabled' if market_id == 'crypto' }} load-page-or-modal" data-url="{{ url_for('.tickers', market_id='crypto', only_content=True, status=status, modal=modal) }}">Crypto</span>
  <span class="nav-link {{ 'active disabled' if market_id == 'stocks' }} load-page-or-modal" data-url="{{ url_for('.tickers', market_id='stocks', only_content=True, status=status, modal=modal) }}">Stocks</span>
</nav>

{% if tickers %}
  <div class="big-table">
    <form id="WhitelistForm" action="{{ url_for('.whitelist_action') }}">
      <table class="table table-sm align-middle table-hover bootstrap-table" data-search="true">
        <thead>
          <tr>
            <th class="main-tab-checkbox">
              <input class="form-check-input check-all" type="checkbox">
            </th>
            <th data-sortable="true">Наименование</th>
            <th>Уведомления</th>
            <th>Комментарий</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          {% for whitelist_ticker in tickers|sort(attribute="ticker.name") %}
            {% set ticker = whitelist_ticker.ticker %}

            <tr>
              <td>
                <input class="form-check-input to-check" type="checkbox" value="{{ ticker.id }}">
              </td>

              <td class="text-average text-truncate">
                <div class="open-modal d-flex gap-2" data-modal-id="WhitelistTickerInfoModal" 
                  data-url="{{ url_for('.ticker_info', market_id=ticker.market_id, ticker_id=ticker.id) }}">

                  {% if ticker.image %}<img class="img-asset-min" src="{{ ticker.image }}">{% endif %}
                  {{ ticker.name }}
                  <span class="text-muted">{{ ticker.symbol|upper }}</span>
                </div>
              </td>

              <td>
                {% for alert in whitelist_ticker.alerts if alert.status != 'off' %}
                  <span class="badge {{ 'text-bg-success' if alert.status == 'worked' else 'text-bg-light' }} fw-normal none-cursor">
                    ${{ alert.price|number_group }}
                  </span>
                {% endfor %}
              </td>

              <td>
                {{ whitelist_ticker.comment if whitelist_ticker.comment }}
              </td>
              
              <td class="align-middle text-end">
	              <div class="dropdown dropstart">
	                <a href="#" class="link-secondary" role="button" id="dropdownAction" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg>
                  </a>
                  <div class="dropdown-menu" aria-labelledby="dropdownAction">
                    <a class="dropdown-item link-danger {{ 'open-modal-confirmation' if True else 'opacity-25 disabled' }}" data-action="delete" data-title="Удалить актив {{ ticker.name }}?" data-id="{{ ticker.id }}">
                      Удалить
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Actions buttons -->
      <div class="sticky-bottom-buttons">
        <a class="open-modal-confirmation" data-action="delete" data-title="Удалить активы?">Удалить</a>
      </div>

    </form>
  </div>

{% else %}
  <div class="nothing-box">Пока ничего нет...</div>
{% endif %}

<script>

{% if not modal and not only_content %}
  // Add New Asset
  $('body').on("click", '.select-asset', function () {
    var ticker_id = $(this).attr('data-ticker-id'),
      url = "{{ url_for('.add_ticker') }}" + "?ticker_id=" + ticker_id;

    $(this).closest('.modal').modal('hide');
    LoadToModal('WhitelistTickerInfoModal', url, true, false);
  });
{% endif %}

</script>
{% endblock %}
