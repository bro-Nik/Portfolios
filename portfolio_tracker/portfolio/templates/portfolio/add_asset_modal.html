{% extends "modal_base.html" %}
{% set modal_fullscreen = False %}

{% set modal_title = 'Добавить актив' %}

{% block content %}

<div id="AssetsGeneralBox" class="add-tickers-box">
  <div class="search">
    <input class="border rounded-3 w-100 mb-3 px-3 focus" placeholder="Поиск"></input>
  </div> 
  <div id="AssetsBox" class="overflow-y-auto">
    <div id="AssetsList" class="hover-child-color" data-page="1">
    </div> 
  </div> 
</div>

<script>
  var tickers_loading_started = false;
  var end_of_tickers = false;
  var UpdateTickersTimerId = 0;

  $('#AssetsGeneralBox .search input').on("input", function () {
    clearTimeout(UpdateTickersTimerId);
    UpdateTickersTimerId = setTimeout(function () {
      end_of_tickers = false;
      UpdateTickers('search', 1)
    }, 500);
  });


  function UpdateTickers(type, page) {
    if (tickers_loading_started) {
      return false;
    }

    tickers_loading_started = true;

    var $assetsList = $("#AssetsList");
      url = "{{ url_for('portfolio.asset_add_tickers', market_id=market_id)}}",
      search = $('#AssetsGeneralBox .search input').val();

    url += "?page=" + page;
    if (search) {
      url += "&search=" + search;
    }

    $.get(url, function (data) {
      if (data == 'end') {
        if (type == 'search') {
          $assetsList.html('Ничего не найдено');
        } else {
          end_of_tickers = true;
        }
      } else {
        if (type == 'search') {
          $assetsList.empty().append(data);
        } else {
          $assetsList.append(data);
        }
        $assetsList.attr('data-page', page);
      }

      tickers_loading_started = false;
    });

  }
  UpdateTickers('', 1);

 
$('#AssetsBox').scroll(function(){
  if (!end_of_tickers) {
	  var $assets_list = $('#AssetsList'),
	    $assets_box = $('#AssetsBox'),
	    threshold = $assets_box.height() / 4,
	    position = $assets_box.scrollTop();

	  if ($assets_list.height() - position - $assets_box.height() <= threshold) {
      UpdateTickers('pagination', +$assets_list.attr('data-page') + 1);
	  }
  }
});
	
// Add New Asset
$('#AssetsBox').on("click", '.select-asset', function () {
  var ticker_id = "?ticker_id=" + $(this).attr('data-ticker-id'),
    url = "{{ url_for('.asset_add', portfolio_id=portfolio_id) }}" + ticker_id,
    $modal = $(this).closest('.modal'),
    pre_modal_id = $modal.attr('data-pre-modal-id');

  $modal.modal('hide');

  $.get(url).done(function (data) {
    LoadToModal('AssetInfoModal', data, true, pre_modal_id);
  })
});
</script>
{% endblock %}
